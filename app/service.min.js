/**
 * Created by Han Chen on 24/02/2015.
 */
app.service("$service",["$http","$firebaseAuth","$firebase","$timeout",function(n,e,i){var a=this
this.firebaseURL="https://watminers.firebaseio.com",this.authObj=null,this.refRanking=null,this.rankings=null,this.refJob=null,this.syncRanking=null,this.authData=null,this.login=function(n,i){a.refRanking=new Firebase(a.firebaseURL),a.authObj=e(a.refRanking),a.authObj.$authWithOAuthPopup("facebook").then(function(e){a.authData=e,console.log("Logged in as:",e),Firebase.goOffline(),n&&n()})["catch"](function(n){console.error("Authentication failed:",n),i&&i("login failed, try referesh the page")})},this.didUserRank=function(n,e){Firebase.goOnline()
var o=new Firebase(a.firebaseURL+"/rankings/"+a.authData.uid),t=i(o).$asArray()
t.$loaded().then(function(){Firebase.goOffline(),console.log(t),t.length>0?(a.rankings=t[0],n&&n()):e&&e()})["catch"](function(){Firebase.goOffline(),e&&e()})},this.addRankings=function(n,e,o){function t(){var t=new Firebase(a.firebaseURL+"/rankings/"+a.authData.uid),s=i(t).$asArray()
s.$add(n).then(function(){Firebase.goOffline(),e&&e()},function(n){console.log(n),Firebase.goOffline(),o&&o()})}Firebase.goOnline(),console.log(n)
for(var s=null,r=0;r<n.length;r++){console.log(n[r]),n[r].displayName=a.authData.facebook.displayName,n[r].jobID+=""
var l=i(new Firebase(a.firebaseURL+"/jobs/"+n[r].jobID))
s=l.$set(a.authData.uid,n[r])["catch"](function(n){o&&o(),console.log(n)})}s.then(t)},this.getRankings=function(n,e){function o(){Firebase.goOnline(),console.log(a.rankings)
for(var e=0;e<a.rankings.length;e++)!function(){var o=e,t=i(new Firebase(a.firebaseURL+"/jobs/"+a.rankings[e].jobID)).$asArray()
t.$loaded().then(function(){o===a.rankings.length-1&&Firebase.goOffline(),n&&n(t)})["catch"](function(n){o===a.rankings.length-1&&Firebase.goOffline(),console.log(n)})}()}a.rankings?o():a.didUserRank(o,e)}}])
