/**
 * Created by Han Chen on 24/02/2015.
 */
var app=angular.module("app",["ui.router","ui.bootstrap","firebase"]).run(function(){})
app.config(["$stateProvider","$urlRouterProvider",function(n,e){e.otherwise("/"),n.state("home",{url:"/",controller:"IntroCtrl",templateUrl:"template/intro.html"}).state("ranking-input",{url:"/ranking-input",controller:"InputCtrl",templateUrl:"template/ranking-input.html"}).state("about",{url:"/about",templateUrl:"template/about.html"}).state("ranking-display",{url:"/ranking-display",controller:"DisplayCtrl",templateUrl:"template/ranking-display.html"})}]),app.controller("InputCtrl",["$scope","$rootScope","$service","$state","$stateParams","$firebase",function(n,e,a,t){function i(){t.go("ranking-display")}function o(){return{jobID:"",ranking:"Ranked",preference:0}}if(null===a.authData)t.go("home")
else{a.didUserRank(i,function(){n.isLoading=!1}),n.isLoading=!0,n.rankings=[]
for(var r=0;3>r;r++)n.rankings.push(o()),console.log(n.rankings)
n.addAnother=function(){n.rankings.push(o())},n.deleteRecord=function(e){n.rankings.splice(e,1)},n.submit=function(){var e=function(){t.go("ranking-display")},i=function(e){n.message=e}
console.log(n.rankings),a.addRankings(angular.copy(n.rankings),e,i)}}}]).controller("IntroCtrl",["$scope","$rootScope","$state","$stateParams","$firebaseAuth","$service",function(n,e,a,t,i,o){n.login=function(){var n=function(){a.go("ranking-input")},e=function(n){alert(n)}
o.login(n,e)}}]).controller("DisplayCtrl",["$scope","$rootScope","$service","$state","$stateParams",function(n,e,a,t){a.authData?(n.rankings=[],a.getRankings(function(e){console.log(e)
for(var a=0;a<e.length;a++)n.rankings.push(e[a])},function(n){console.log(n),t.go("home")})):t.go("home")}]),app.service("$service",["$http","$firebaseAuth","$firebase","$timeout",function(n,e,a){var t=this
this.firebaseURL="https://watminers.firebaseio.com",this.refRanking=new Firebase(t.firebaseURL),this.authObj=e(t.refRanking),this.rankings=null,this.refJob=null,this.syncRanking=null,this.authData=this.authObj.$getAuth(),Firebase.goOffline(),this.login=function(n,e){Firebase.goOnline(),t.authObj.$authWithOAuthPopup("facebook").then(function(e){t.authData=e,console.log("Logged in as:",e),Firebase.goOffline(),n&&n()})["catch"](function(n){Firebase.goOffline(),console.error("Authentication failed:",n),e&&e("login failed, try referesh the page")})},this.didUserRank=function(n,e){Firebase.goOnline()
var i=new Firebase(t.firebaseURL+"/rankings/"+t.authData.uid),o=a(i).$asArray()
o.$loaded().then(function(){Firebase.goOffline(),console.log(o),o.length>0?(t.rankings=o[0],n&&n()):e&&e()})["catch"](function(){Firebase.goOffline(),e&&e()})},this.addRankings=function(n,e,i){function o(){var o=new Firebase(t.firebaseURL+"/rankings/"+t.authData.uid),r=a(o).$asArray()
r.$add(n).then(function(){Firebase.goOffline(),e&&e()},function(n){console.log(n),Firebase.goOffline(),i&&i()})}Firebase.goOnline(),console.log(n)
for(var r=null,s=0;s<n.length;s++){console.log(n[s]),n[s].displayName=t.authData.facebook.displayName,n[s].jobID+=""
var l=a(new Firebase(t.firebaseURL+"/jobs/"+n[s].jobID))
r=l.$set(t.authData.uid,n[s])["catch"](function(n){i&&i(),console.log(n)})}r.then(o)},this.getRankings=function(n,e){function i(){Firebase.goOnline(),console.log(t.rankings)
for(var e=0;e<t.rankings.length;e++)!function(){var i=e,o=a(new Firebase(t.firebaseURL+"/jobs/"+t.rankings[e].jobID)).$asArray()
o.$loaded().then(function(){i===t.rankings.length-1&&Firebase.goOffline(),n&&n(o)})["catch"](function(n){i===t.rankings.length-1&&Firebase.goOffline(),console.log(n)})}()}t.rankings?i():t.didUserRank(i,e)}}])
