/**
 * Created by Han Chen on 24/02/2015.
 */
app.service("$service",["$http","$firebaseAuth","$firebase","$timeout",function(e,n,i){var a=this
this.firebaseURL="https://watminers.firebaseio.com",this.refRanking=new Firebase(a.firebaseURL),this.authObj=n(a.refRanking),this.rankings=null,this.refJob=null,this.syncRanking=null,this.authData=this.authObj.$getAuth(),Firebase.goOffline(),this.login=function(e,n){Firebase.goOnline(),a.authObj.$authWithOAuthPopup("facebook").then(function(n){a.authData=n,console.log("Logged in as:",n),Firebase.goOffline(),e&&e()})["catch"](function(e){Firebase.goOffline(),console.error("Authentication failed:",e),n&&n("login failed, try referesh the page")})},this.didUserRank=function(e,n){Firebase.goOnline()
var o=new Firebase(a.firebaseURL+"/rankings/"+a.authData.uid),r=i(o).$asArray()
r.$loaded().then(function(){Firebase.goOffline(),console.log(r),r.length>0?(a.rankings=r[0],e&&e()):n&&n()})["catch"](function(){Firebase.goOffline(),n&&n()})},this.addRankings=function(e,n,o){function r(){var r=new Firebase(a.firebaseURL+"/rankings/"+a.authData.uid),t=i(r).$asArray()
t.$add(e).then(function(){Firebase.goOffline(),n&&n()},function(e){console.log(e),Firebase.goOffline(),o&&o()})}for(var t=0;t<e.length;t++){if(8!==e[t].jobID.length||isNaN(e[t].jobID))return void o("Please check if your jobID is the right format before submitting")
if(isNaN(e[t].preference)||e[t].preference<-1||e[t].preference>9)return void o("Please check if your preference is the right format before submitting")
for(var s=0;t>s;s++)if(e[t].jobID==e[s].jobID)return void o("You have duplicate jobID")}Firebase.goOnline(),console.log(e)
for(var f=null,h=0;h<e.length;h++){console.log(e[h]),e[h].displayName=a.authData.facebook.displayName,e[h].jobID+=""
var l=i(new Firebase(a.firebaseURL+"/jobs/"+e[h].jobID))
f=l.$set(a.authData.uid,e[h])["catch"](function(e){o&&o("there is an error submitting your rankings, perhaps your data format is invalid"),console.log(e)})}f.then(r)},this.getRankings=function(e,n){function o(){Firebase.goOnline(),console.log(a.rankings)
for(var n=0;n<a.rankings.length;n++)!function(){var o=n,r=i(new Firebase(a.firebaseURL+"/jobs/"+a.rankings[n].jobID)).$asArray()
r.$loaded().then(function(){o===a.rankings.length-1&&Firebase.goOffline(),e&&e(r)})["catch"](function(e){o===a.rankings.length-1&&Firebase.goOffline(),console.log(e)})}()}a.rankings?o():a.didUserRank(o,n)}}])
